<Doctype HTML>
<HTML>
	<head>
		<meta charset="utf-8">
		<title>Name That Player!</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
		<link rel="icon" type="image/png" href="public/favicon-96x96.png" sizes="96x96">
  		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"> 
  		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> 
  		<link rel="stylesheet" type="text/css" href="style.css">  

		<script>
			var playerCounter = 0;
			var currPlayer;
			var nextPlayer;
			var playerList = [];
			var score;
			function init() {
				$('#main').show();
				$('#scores').html('');
				playerCounter = 0;
				score = 0;
				var time = 10;
		  		var timer = setInterval(function() { 
		  			time--;
		  			$('#timer').html("Seconds Left: " + time);
		  			if(time === 0) {
		  				$('#main').hide();
		  				$('#scores').show();
		  				$('#alert').show();
		  				checkHighScore();
		  				clearInterval(timer);
		  			} 
		  		}, 1000);
				$.ajax({
				  url: '/players',
				  complete: function(data) {
				    playerList = data.responseJSON.playerList;
				    console.log(data);
				    currPlayer = playerList[Math.floor(playerList.length * Math.random())];
				    nextPlayer = playerList[Math.floor(playerList.length * Math.random())];
				    //$('#img').css({'background-image': 'url(' + nextPlayer.url + ')'});
				    $('#img').html("<img id='" + playerCounter + "' src=' " + currPlayer.url +"' onError=newPlayer(false)>");
				    playerCounter++;
				    $('#img').append("<img id='" + playerCounter + "' src=' " + nextPlayer.url +"' style='display:none' onError=changeNext(" + playerCounter + ")>");
				  }
				});
			}
			init();
			//Load up 2 players at a time so there are smooth transitions
			function newPlayer(pass){ 
					$('#' + playerCounter).show();
					$('#' + (playerCounter - 1) ).remove(); 
					currPlayer = nextPlayer;
					console.log(currPlayer.name);
					var randIndex = Math.floor(playerList.length * Math.random());
					nextPlayer = playerList[randIndex];
					console.log(currPlayer);
					if(!pass) {
						playerList.splice(randIndex, 1); //Take player out of remaining players if the player didn't pass.
					}
					console.log("player Counter : " + playerCounter);
					$('#img').html("<img id='" + playerCounter + "' src=' " + currPlayer.url +"' onError=newPlayer(false)>");
				    playerCounter++;
				    $('#img').append("<img id='" + playerCounter + "' src=' " + nextPlayer.url +"' style='display:none' onError='changeNext(" + playerCounter + ")'>");

			}
			function checkHighScore(){
				$.ajax({
				  url: '/highscores',
				  complete: function(data) {
				  	var highScores = data.responseJSON.scores;
				  	console.log(highScores);
				  	var smallest = highScores[highScores.length-1];
				  	if (score > smallest || smallest == null) {
				  		$('#scores').append('<h1>You got ' + score + ' points!</h1>');
				  		$("#scores").append('<h2>Congratulations, you got a High Score!</h2><br>')
				  		$("#scores").append('<label for="name">Enter name here: </label>');
				  		$("#scores").append('<input id="name" type="text"><br>')
				  		$("#scores").append('<button onclick="addHighScore(' + highScores + ')">Submit</button>')
				  		
				  		
				  		
				  	}
				  }
				});
			}
			function addHighScore(highScores){
				if(highScores) {
					highScores = highScores.splice(highScores.length-1, 1);//Splice out the smallest score and replace with current score
					highScores.name = score; 
				} else {
					var highScores = {};
					highScores.name = score;
				}
				$.ajax({
					  type: "POST",
					  url: "/postScores",
					  data: highScores,
					  success: null,
					  dataType: "json"
					});
			}
			function changeNext(playerCounter){//Handles bad pictures and changes next picture
				console.log("error");
				playerList.splice(nextPlayer,1);
				var randIndex = Math.floor(playerList.length * Math.random());
				nextPlayer = playerList[randIndex];
				console.log(nextPlayer.name + " " + playerCounter);
				console.log(playerCounter);
				$('#'+playerCounter).html("<img id='" + playerCounter + "' src=' " + nextPlayer.url +"' style='display:none' onError=changeNext(" + playerCounter + ")>");
			}
			function check() {
				var guess = $('#answer').val().toLowerCase();
				var answer = currPlayer.name.toLowerCase();
				//Allow user to also put in last name
				var lastNameGuessArray = guess.split(/[\s-]/);
				var lastNameArray = answer.split(" ");
				console.log(lastNameGuessArray);
				console.log(lastNameArray);
				var lastNameGuess = "";
				var lastName = "";
				for(var i = 0; i < lastNameArray.length; i++) {
					lastNameGuess +=lastNameGuessArray[i];
					lastName += lastNameArray[i+1];
				}
				console.log(guess);
				console.log(answer);
				console.log(lastNameGuess);
				console.log(lastName);
				if(guess === answer || lastNameGuess === lastName) {
					newPlayer(false);
					score+=1;
					$('#score').html("Score: " + score);
				} 
				$('#answer').val('');
			}
			//Pressing the 'enter' key also submits answer
			window.addEventListener('keydown', function(e) {
				if (e.keyCode === 13) {
					check();
				}
			});
		</script>
	</head>
	<body>
		<h1>Name That Player!</h1>
		<div id='main'>
			<div id="timer"></div><br>
			<div id="img"></div><br>
			<input id="answer" type="text"><br>
			<button onclick="check()">Enter</button>
			<button onclick="newPlayer(true)">Pass</button>	
			<div id="score">Score: 0</div>
		</div>
		<div id="scores"></div>
		<div id="alert" style='display:none'>
			<br><button onclick="init()">Play Again?</button>
			<br><button onclick="highScores()">High Scores</button>
		</div>
	</body>
<HTML>